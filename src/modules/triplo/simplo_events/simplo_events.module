<?php

  function simplo_events_node_presave($node) {
    if ($node->type == 'simplo_session') {
      backdrop_set_message($message = "This is the Simplo Events Module", $type = 'status', $repeat = TRUE);

      // release previous time slot
      if (isset($node->original->field_time_slot['und'][0]['nid'])) {
        backdrop_set_message($message = "release previous time slot.", $type = 'status', $repeat = TRUE);
        $old_time = $node->original->field_time_slot['und'][0]['nid'];
        $time_slot = node_load($old_time);
        $time_slot->field_slot_taken['und'][0]['value'] = 0;
        backdrop_set_message($message = "Time slot status = " . $time_slot->field_slot_taken['und'][0]['value'], $type = 'status', $repeat = TRUE);
        $time_slot->save();
      }

      // claim open time slot
      if (isset($node->field_time_slot['und'][0]['nid'])) {
        backdrop_set_message($message = "claim open time slot.  ", $type = 'status', $repeat = TRUE);
        $new_time = $node->field_time_slot['und'][0]['nid'];
        $time_slot = node_load($new_time);
        $time_slot->field_slot_taken['und'][0]['value'] = 1;
        $time_slot->save();

        $old_time = $node->original->field_time_slot['und'][0]['nid'];
        if ($old_time != $node->field_scheduled_time['und'][0]['nid']) {
          $node->field_scheduled_time['und'][0]['nid'] = $new_time;
        }
      }
    }
  }






